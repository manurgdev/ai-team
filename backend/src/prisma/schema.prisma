// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hash
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  apiKeys      ApiKey[]
  githubTokens GitHubToken[]
  tasks        Task[]
  exports      Export[]
}

model ApiKey {
  id           String   @id @default(uuid())
  userId       String
  provider     String   // 'anthropic', 'openai', 'google'
  encryptedKey String   // AES-256 encrypted
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

model GitHubToken {
  id             String   @id @default(uuid())
  userId         String   @unique
  encryptedToken String   // AES-256 encrypted
  githubUsername String?  // Optional GitHub username for display
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id                    String    @id @default(uuid())
  userId                String
  title                 String
  description           String    @db.Text
  selectedAgents        String[]  // Array of agent roles
  executionMode         String    // 'sequential' or 'parallel'
  status                String    // 'pending', 'running', 'completed', 'error'
  provider              String    // Which AI provider was used
  model                 String?   // Which specific model was used (e.g., 'claude-3-5-sonnet-20241022')
  githubContext         Json?     // GitHub repository context with selected files
  createdAt             DateTime  @default(now())
  completedAt           DateTime?
  hasNextPhase          Boolean   @default(false) // Indicates if there are more phases to implement
  nextPhaseDescription  String?   @db.Text // Description of what the next phase should include
  currentPhase          String?   // E.g., "Phase 1", "Phase 2", null if not phased
  parentTaskId          String?   // Reference to the original task if this is a continuation

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agentOutputs AgentOutput[]
  exports      Export[]
}

model AgentOutput {
  id            String   @id @default(uuid())
  taskId        String
  agentRole     String   // 'tech-lead', 'product-owner', etc.
  content       String   @db.Text
  artifacts     Json?    // Array of {type, filename, content, language}
  status        String   // 'success', 'error'
  error         String?  @db.Text
  executionTime Int?     // milliseconds
  inputTokens   Int?     // Number of input tokens used
  outputTokens  Int?     // Number of output tokens generated
  totalTokens   Int?     // Total tokens (input + output)
  estimatedCost Float?   // Estimated cost in USD
  executionLog  Json?    // Detailed execution log with steps, tool calls, and results
  createdAt     DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Export {
  id             String   @id @default(uuid())
  userId         String
  taskId         String
  repositoryUrl  String
  branchName     String
  pullRequestUrl String?
  status         String   // 'pending', 'completed', 'error'
  error          String?  @db.Text
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}
